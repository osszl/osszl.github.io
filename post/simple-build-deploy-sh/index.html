<!DOCTYPE html>
<html lang="zh-cn">
<head>

  <meta charset="utf-8" />

  
  <title>一个简易的项目构建与部署脚本</title>

  
  





  
  <meta name="author" content="居闲" />
  <meta name="description" content="在创始型的一个物流互联网平台团队里，有伙伴反复抱怨为了适用不同的环境构建、部署工程要多长多长的时间，而且一步小心就忘了啥，劳神费时！交接情况后，发现基本如此，并且一些当前高大上的一些做法也无法开展。
思前思后，觉得搞个脚本能解决些体力的事情。于是硬着头皮一遍凭着很久前对 shell 的一些记忆，一边百度，写了2个脚本。

" />

  
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@gohugoio" />
    <meta name="twitter:title" content="一个简易的项目构建与部署脚本" />
    <meta name="twitter:description" content="在创始型的一个物流互联网平台团队里，有伙伴反复抱怨为了适用不同的环境构建、部署工程要多长多长的时间，而且一步小心就忘了啥，劳神费时！交接情况后，发现基本如此，并且一些当前高大上的一些做法也无法开展。
思前思后，觉得搞个脚本能解决些体力的事情。于是硬着头皮一遍凭着很久前对 shell 的一些记忆，一边百度，写了2个脚本。

" />
    <meta name="twitter:image" content="http://www.szlx.me/img/avatar.jpg" />
  

  
  <meta property="og:type" content="article" />
  <meta property="og:title" content="一个简易的项目构建与部署脚本" />
  <meta property="og:description" content="在创始型的一个物流互联网平台团队里，有伙伴反复抱怨为了适用不同的环境构建、部署工程要多长多长的时间，而且一步小心就忘了啥，劳神费时！交接情况后，发现基本如此，并且一些当前高大上的一些做法也无法开展。
思前思后，觉得搞个脚本能解决些体力的事情。于是硬着头皮一遍凭着很久前对 shell 的一些记忆，一边百度，写了2个脚本。

" />
  <meta property="og:url" content="http://www.szlx.me/post/simple-build-deploy-sh/" />
  <meta property="og:image" content="http://www.szlx.me/img/avatar.jpg" />




<meta name="generator" content="Hugo 0.44" />


<link rel="canonical" href="http://www.szlx.me/post/simple-build-deploy-sh/" />
<link rel="alternative" href="http://www.szlx.me/index.xml" title="在路上" type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />







<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="在路上" />
<meta name="msapplication-tooltip" content="在路上" />
<meta name='msapplication-navbutton-color' content="#5fbf5e" />
<meta name="msapplication-TileColor" content="#5fbf5e" />
<meta name="msapplication-TileImage" content="/img/tile-image-windows.png" />
<link rel="icon" href="http://www.szlx.me/img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="http://www.szlx.me/img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="http://www.szlx.me/img/favicon-32x32.png" />
<link rel="icon" sizes="192x192" href="http://www.szlx.me/img/touch-icon-android.png" />
<link rel="apple-touch-icon" href="http://www.szlx.me/img/touch-icon-apple.png" />
<link rel="mask-icon" href="http://www.szlx.me/img/safari-pinned-tab.svg" color="#5fbf5e" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.8/alt/video-js-cdn.min.css" />

<link rel="stylesheet" href="http://www.szlx.me/css/bundle.ff02473a9a.css" />


  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
        <a title="Go to comments" class="to-comment" href="#disqus_thread"><span class="icon icon-comment"></span></a>
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="http://www.szlx.me/img/avatar.jpg" alt="Avatar">
  
  <h2 class="title">在路上</h2>
  
  <p class="subtitle">这里也有诗，但那里还有星辰与大海</p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
            
            
            
              is-active
            ">
            <a href="http://www.szlx.me/">首页</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://gitee.com/lxrj/validation">作品</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="http://www.szlx.me/tags/">标签</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="http://www.szlx.me/links/">友链</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="http://www.szlx.me/about/">关于</a>
          </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list">

      
      <li class="social-item">
        <a href="mailto:lxrjszl@qq.com" title="Email"><span class="icon icon-email"></span></a>
      </li>

      
      <li class="social-item">
        <a href="//github.com/lxrjszl@qq.com" title="GitHub"><span class="icon icon-github"></span></a>
      </li>

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <li class="social-item">
        <a href="http://www.szlx.me/img/qrcode.jpg" title="Wechat"><span class="icon icon-wechat"></span></a>
      </li>

      

      

      

      

      <li class="social-item">
        <a href="http://www.szlx.me/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
      </li>

    </ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">一个简易的项目构建与部署脚本</h1>
      <p class="post-meta">@居闲 · Jan 3, 2018 · 6 min read</p>
    </header>
    <article class="post-content"><p>在创始型的一个物流互联网平台团队里，有伙伴反复抱怨为了适用不同的环境构建、部署工程要多长多长的时间，而且一步小心就忘了啥，劳神费时！交接情况后，发现基本如此，并且一些当前高大上的一些做法也无法开展。</p>

<p>思前思后，觉得搞个脚本能解决些体力的事情。于是硬着头皮一遍凭着很久前对 shell 的一些记忆，一边百度，写了2个脚本。</p>

<p></p>

<h2 id="工程介绍">工程介绍</h2>

<p>工程部署在阿里云上，采用了不少的阿里云服务，是个比较典型前后端完全分离的小型分布式平台：</p>

<ol>
<li>dubbo集群实现业务逻辑服务；</li>
<li>SpringMVC集群实现Restful服务；</li>
<li>nginx发布静态网站，负载均衡和流控等。</li>
</ol>

<h2 id="构建脚本">构建脚本</h2>

<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">140
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">141
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">142
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">143
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">144
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">145
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">146
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">147
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">148
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">149
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">150
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">151
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">152
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">153
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">154
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">155
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">156
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">157
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">158
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">159
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">160
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">161
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">162
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">163
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">164
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">165
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">166
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">167
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">168
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">169
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">170
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">171
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">172
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">173
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">174
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">175
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">176
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">177
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">178
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">179
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">180
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">181
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">182
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">183
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">184
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>    
ARTIFACT_LIST_SERVICE<span style="color:#f92672">=(</span>tms ams oms ams-web oms-web<span style="color:#f92672">)</span>
ARTIFACT_LIST_H5<span style="color:#f92672">=(</span>manager<span style="color:#f92672">)</span>
ARTIFACT_LIST_ALL<span style="color:#f92672">=(</span><span style="color:#e6db74">${</span>ARTIFACT_LIST_SERVICE[*]<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>ARTIFACT_LIST_H5[*]<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>
ARTIFACTS<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ARTIFACT_LIST_ALL[*]<span style="color:#e6db74">}</span>
HAS_SERVICE<span style="color:#f92672">=</span>FALSE
HAS_H5<span style="color:#f92672">=</span>FALSE
PROFILE<span style="color:#f92672">=</span>
    
VERSION<span style="color:#f92672">=</span>
BUILD_NUMBER<span style="color:#f92672">=</span>
TAG<span style="color:#f92672">=</span>

ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>getopt -o a:p:v:h --long artifact:,profile:,version:,help<span style="color:#e6db74">&#39;build.sh&#39;</span> -- <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">`</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? !<span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    echo -e <span style="color:#e6db74">&#34;参数\033[49;31;4m错误\033[0m，程序已经终止。&#34;</span>
    exit <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">fi</span>
eval set -- <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ARGS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#66d9ef">while</span> true
<span style="color:#66d9ef">do</span>
    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> in
        -a|--artifact<span style="color:#f92672">)</span>
            UPPER_ARTIFACTS<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $2 | tr <span style="color:#e6db74">&#39;[a-z]&#39;</span> <span style="color:#e6db74">&#39;[A-Z]&#39;</span><span style="color:#66d9ef">)</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$UPPER_ARTIFACTS<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ALL&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
                ARTIFACTS<span style="color:#f92672">=(</span><span style="color:#e6db74">${</span>ARTIFACT_LIST_ALL[*]<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>
            <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$UPPER_ARTIFACTS<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SERVICE&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
                ARTIFACTS<span style="color:#f92672">=(</span><span style="color:#e6db74">${</span>ARTIFACT_LIST_SERVICE[*]<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>
            <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$UPPER_ARTIFACTS<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;H5&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
                ARTIFACTS<span style="color:#f92672">=(</span><span style="color:#e6db74">${</span>ARTIFACT_LIST_H5[*]<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>
            <span style="color:#66d9ef">else</span>
                ARTIFACTS<span style="color:#f92672">=(</span>$2<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">fi</span>
            shift <span style="color:#ae81ff">2</span>;
            ;;
        -p|--profile<span style="color:#f92672">)</span>
            PROFILE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $2 | tr <span style="color:#e6db74">&#39;[a-z]&#39;</span> <span style="color:#e6db74">&#39;[A-Z]&#39;</span><span style="color:#66d9ef">)</span>
            shift <span style="color:#ae81ff">2</span>;
            ;;
        -v|--version<span style="color:#f92672">)</span>
            VERSION<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span>
            shift <span style="color:#ae81ff">2</span>;
            ;;
        --help<span style="color:#f92672">)</span>
            echo <span style="color:#e6db74">&#34;只支持以下参数：&#34;</span>
            echo <span style="color:#e6db74">&#34;-a | --artifact :  构建名称(</span><span style="color:#e6db74">${</span>ARTIFACT_LIST_ALL[或构建类别(ALL, SERVICE, H5)<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">            echo &#34;</span>-p | --profile :  构建名称的环境(test 或 prod)<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">            echo &#34;</span>-v | --version : 构建产物的版本号，如果不指定则忽略。<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">            echo &#34;</span>-h |--help : 显示帮助信息<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">            exit 1
</span><span style="color:#e6db74">            ;;
</span><span style="color:#e6db74">        --)
</span><span style="color:#e6db74">            shift
</span><span style="color:#e6db74">            break
</span><span style="color:#e6db74">            ;;
</span><span style="color:#e6db74">        *)
</span><span style="color:#e6db74">            echo &#34;</span>Internal error!<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">            exit 1
</span><span style="color:#e6db74">            ;;
</span><span style="color:#e6db74">    esac
</span><span style="color:#e6db74">done
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">if [[ </span>$PROFILE<span style="color:#e6db74"> = &#34;</span>PROD<span style="color:#e6db74">&#34; || </span>$PROFILE<span style="color:#e6db74"> = &#34;</span>ALITEST<span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">    echo -e &#34;</span><span style="color:#ae81ff">\0</span>33[33m构建<span style="color:#e6db74">${</span>PROFILE<span style="color:#e6db74">}</span>环境<span style="color:#ae81ff">\0</span>33[0m<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74"> elif [[ -z &#34;</span>$PROFILE<span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">    echo -e &#34;</span><span style="color:#ae81ff">\0</span>33[33m必须指定构建产物的部署环境<span style="color:#ae81ff">\0</span>33[0m<span style="color:#e6db74">&#34; 
</span><span style="color:#e6db74">else
</span><span style="color:#e6db74">    echo -e &#34;</span><span style="color:#ae81ff">\0</span>33[31;1m不能识别(支持)的构建环境：<span style="color:#e6db74">${</span>PROFILE<span style="color:#e6db74">}</span><span style="color:#ae81ff">\0</span>33[0m<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    exit 1
</span><span style="color:#e6db74">fi
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">for artifact in </span><span style="color:#e6db74">${</span>ARTIFACTS[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span><span style="color:#e6db74">do
</span><span style="color:#e6db74">    for service in </span><span style="color:#e6db74">${</span>ARTIFACT_LIST_SERVICE[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    do
</span><span style="color:#e6db74">        if [[ &#34;</span>$artifact<span style="color:#e6db74">&#34; = &#34;</span>$service<span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">            HAS_SERVICE=TRUE
</span><span style="color:#e6db74">            break
</span><span style="color:#e6db74">        fi
</span><span style="color:#e6db74">    done
</span><span style="color:#e6db74">    for h5 in </span><span style="color:#e6db74">${</span>ARTIFACT_LIST_H5[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">         
</span><span style="color:#e6db74">    do    
</span><span style="color:#e6db74">        if [[ &#34;</span>$artifact<span style="color:#e6db74">&#34; = &#34;</span>$h5<span style="color:#e6db74">&#34; ]]; then    
</span><span style="color:#e6db74">            HAS_H5=TRUE                    
</span><span style="color:#e6db74">            break    
</span><span style="color:#e6db74">        fi          
</span><span style="color:#e6db74">    done
</span><span style="color:#e6db74">done
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">BUILD_PATH=&#34;</span>/opt/build<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">BUILD_NUMBER_FILE=&#34;</span><span style="color:#e6db74">${</span>BUILD_PATH<span style="color:#e6db74">}</span>/build_number<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">if [[ ! -f &#34;</span>$BUILD_NUMBER_FILE<span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">    echo 0 &gt; &#34;</span>$BUILD_NUMBER_FILE<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">fi
</span><span style="color:#e6db74">BUILD_NUMBER=`cat </span>$BUILD_NUMBER_FILE<span style="color:#e6db74">`
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">if [[ -z &#34;</span>$BUILD_NUMBER<span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">    echo&#34;</span><span style="color:#ae81ff">\0</span>33[49;31;1m请在构建信息文件<span style="color:#e6db74">${</span>BUILD_NUMBER_FILE<span style="color:#e6db74">}</span>中指定初始构建非负整数)<span style="color:#ae81ff">\0</span>33[0m<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    exit 1
</span><span style="color:#e6db74">elif [[ &#34;</span>$PROFILE<span style="color:#e6db74">&#34; != &#34;</span>PROD<span style="color:#e6db74">&#34;  ]]; then 发布的版本基于测试版本，不升级构建版本号
</span><span style="color:#e6db74">    BUILD_NUMBER=</span>$<span style="color:#e6db74">[BUILD_NUMBER+1]
</span><span style="color:#e6db74">fi
</span><span style="color:#e6db74">echo </span>$BUILD_NUMBER<span style="color:#e6db74"> &gt; &#34;</span>$BUILD_NUMBER_FILE<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">if [[ ! -z &#34;</span>$VERSION<span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">    TAG=&#34;</span><span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span>-<span style="color:#e6db74">${</span>BUILD_NUMBER<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">else
</span><span style="color:#e6db74">    TAG=&#34;</span>$BUILD_NUMBER<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">fi
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"># 创建 BUILD_NUMBER 产出物的跟目录 
</span><span style="color:#e6db74">BUILD_REPO=&#34;</span><span style="color:#e6db74">${</span>BUILD_PATH<span style="color:#e6db74">}</span>/<span style="color:#66d9ef">$(</span>echo $PROFILE | tr <span style="color:#e6db74">&#39;[A-Z]a-z]&#39;</span><span style="color:#66d9ef">)</span>_<span style="color:#e6db74">${</span>BUILD_NUMBER<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">mkdir &#34;</span>$BUILD_REPO<span style="color:#e6db74">&#34; &gt; /dev/null
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"># </span>$1<span style="color:#e6db74">=svnSource, </span>$2<span style="color:#e6db74">=tag, </span>$3<span style="color:#e6db74">=logFile, ret=tagUrl
</span><span style="color:#e6db74">SVN_TAG_URL=
</span><span style="color:#e6db74">function create_svn_tag
</span><span style="color:#e6db74">{
</span><span style="color:#e6db74">    CREATE_TIME=`date &#34;</span>+%Y-%m-%d %H:%M:%S<span style="color:#e6db74">&#34;`
</span><span style="color:#e6db74">    SVN_TAG_URL=&#34;</span><span style="color:#e6db74">${</span>1<span style="color:#e6db74">}</span>Tags/<span style="color:#e6db74">${</span>TAG<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    svn copy </span><span style="color:#e6db74">${</span>1<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>SVN_TAG_URL<span style="color:#e6db74">}</span><span style="color:#e6db74"> -m &#34;</span>构建服务器创建于 <span style="color:#e6db74">${</span>CREATE_TIME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    echo -n &#34;</span>$CREATE_TIME<span style="color:#e6db74">&#34; &gt;&gt; &#34;</span><span style="color:#e6db74">${</span>3<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    echo  &#34;</span>   创建源代码标签：<span style="color:#e6db74">${</span>2<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; &gt;&gt; &#34;</span><span style="color:#e6db74">${</span>3<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    echo  &#34;</span>   创建源代码标签：<span style="color:#e6db74">${</span>2<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; 
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">SVN_REPO_BASE=&#34;</span>https://116.228.168.118:700/svn/intelligent-platform/nhxtx<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">SOURCE_BASE_DIR=&#34;</span>/opt/svn/nhxtx/<span style="color:#e6db74">${</span>TAG<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">if [[ ! -d </span>$SOURCE_BASE_DIR<span style="color:#e6db74"> ]]; then
</span><span style="color:#e6db74">    if [[ &#34;</span>$PROFILE<span style="color:#e6db74">&#34; = &#34;</span>PROD<span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">        echo -e &#34;</span><span style="color:#ae81ff">\0</span>33[49;31;1m版本<span style="color:#e6db74">${</span>TAG<span style="color:#e6db74">}</span>尚未进行过测试，确定直接发环境吗？<span style="color:#ae81ff">\0</span>33[0m<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">        # 这里添加交互功能
</span><span style="color:#e6db74">        exit 0
</span><span style="color:#e6db74">    else
</span><span style="color:#e6db74">        mkdir </span>$SOURCE_BASE_DIR<span style="color:#e6db74"> || exit 1
</span><span style="color:#e6db74">        create_svn_tag </span>$SVN_REPO_BASE<span style="color:#e6db74"> </span>$TAG<span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>BUILD_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/info
</span><span style="color:#e6db74">        svn co </span>$SVN_TAG_URL<span style="color:#e6db74"> </span>$SOURCE_BASE_DIR<span style="color:#e6db74">
</span><span style="color:#e6db74">        echo  &#34;</span>   更新代码到目录：<span style="color:#e6db74">${</span>SOURCE_BASE_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; &gt;&gt; </span><span style="color:#e6db74">${</span>BUILD_REinfo  
    fi
else
    cd $SOURCE_BASE_DIR
    svn update
fi

if [[ $HAS_SERVICE = <span style="color:#e6db74">&#34;TRUE&#34;</span> ]]; then
    echo -e <span style="color:#e6db74">&#39;\033[32m =======================================\033[0m&#39;</span>
    echo -e <span style="color:#e6db74">&#39;\033[32m *         编译【Java】工程...         *\033[0m&#39;</span>
    echo -e <span style="color:#e6db74">&#39;\033[32m =======================================\033[0m&#39;</span>
    cd $SOURCE_BASE_DIR
    mvn clean package -Pprod -Dmaven.test.skip=true -U || exit -1
    
    # 拷贝Java二进制代码到 BUILD_NUMBER 目录
    echo -e <span style="color:#e6db74">&#34;\033[33m拷贝Java工程编译产物到目录</span><span style="color:#e6db74">${</span>JAVA_BUILD_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">\033[0m&#34;</span>
    for artifact in ams ams-web oms oms-web tms
    do
    echo copying <span style="color:#e6db74">&#34;/opt/svn/nhxtx/</span><span style="color:#e6db74">${</span>artifatarget/<span style="color:#e6db74">${</span>artifact<span style="color:#e6db74">}</span>-1.0.0-SNAPSHOT.jar<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">        mv </span><span style="color:#e6db74">${</span>SOURCE_BASE_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>artifatarget/<span style="color:#e6db74">${</span>artifact<span style="color:#e6db74">}</span>-1.0.0-SNAPSHOT.<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILD_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>artifact<span style="color:#e6db74">}</span><span style="color:#e6db74">.jar&#34;</span>
    done 
    
    echo  -n <span style="color:#e6db74">`</span>date <span style="color:#e6db74">&#34;+%Y-%m-%d %H:%M:%S&#34;</span><span style="color:#e6db74">`</span> &gt;&gt; <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILD_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/info&#34;</span>
    echo  <span style="color:#e6db74">&#34;   构建[服务]成功&#34;</span> &gt;&gt; <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILD_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/info&#34;</span>
fi

if [[ <span style="color:#e6db74">&#34;</span>$HAS_H5<span style="color:#e6db74">&#34;</span> = <span style="color:#e6db74">&#34;TRUE&#34;</span> ]]; then
    echo -e <span style="color:#e6db74">&#39;\033[32m =====================================\033[0m&#39;</span>
    echo -e <span style="color:#e6db74">&#39;\033[32m *        编译 【OMS】 静态工程...   *\033[0m&#39;</span>
    echo -e <span style="color:#e6db74">&#39;\033[32m =====================================\033[0m&#39;</span> 
    sleep 1

    cd <span style="color:#e6db74">${</span>SOURCE_BASE_DIR<span style="color:#e6db74">}</span>/omsH5
    npm install || exit -1
    npm run build-<span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">${</span>PROFILE<span style="color:#e6db74">}</span> | tr <span style="color:#e6db74">&#39;[A-Z]&#39;</span> <span style="color:#e6db74">&#39;[a-z]&#39;</span><span style="color:#66d9ef">)</span> || exit -1

    # 删除main文件
 
    # 拷贝H5静态代码到 BUILD_NUMBER 目录
    echo -e <span style="color:#e6db74">&#34;\033[32m拷贝 OMS H5 工程编译结果到目录</span><span style="color:#e6db74">${</span>JAVA_BUILD_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">\0m&#34;</span>
    mv <span style="color:#e6db74">${</span>SOURCE_BASE_DIR<span style="color:#e6db74">}</span>/omsH5/dist <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILD_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/&#34;</span>
    mv <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILD_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/dist&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILD_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/manager&#34;</span>
    echo -n <span style="color:#e6db74">`</span>date <span style="color:#e6db74">&#34;+%Y-%m-%d %H:%M:%S  &#34;</span><span style="color:#e6db74">`</span> &gt;&gt; <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILD_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/info&#34;</span>
    echo <span style="color:#e6db74">&#34;   构建[H5]成功&#34;</span> &gt;&gt; <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILD_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/info&#34;</span>
fi</code></pre></td></tr></table>
</div>
</div>

<h2 id="部署脚本">部署脚本</h2>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>    
PROFILE<span style="color:#f92672">=</span>prod
SERVER_SERVICE<span style="color:#f92672">=(</span><span style="color:#ae81ff">10</span>.30.*.* <span style="color:#ae81ff">10</span>.30.*.*<span style="color:#f92672">)</span>
SERVER_WEB<span style="color:#f92672">=(</span><span style="color:#ae81ff">10</span>.31.*.* <span style="color:#ae81ff">10</span>.31.*.*<span style="color:#f92672">)</span>
SERVER_H5<span style="color:#f92672">=(</span><span style="color:#ae81ff">10</span>.31.*.* <span style="color:#ae81ff">10</span>.31.*.*<span style="color:#f92672">)</span>

ARTIFACT_SERVICE<span style="color:#f92672">=(</span>tms ams oms<span style="color:#f92672">)</span>
ARTIFACT_WEB<span style="color:#f92672">=(</span>ams-web oms-web<span style="color:#f92672">)</span>
ARTIFACT_JAVA<span style="color:#f92672">=(</span><span style="color:#e6db74">${</span>ARTIFACT_SERVICE[*]<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>ARTIFACT_WEB[*]<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>
ARTIFACT_H5<span style="color:#f92672">=(</span>manager<span style="color:#f92672">)</span>
ARTIFACT_ALL<span style="color:#f92672">=(</span><span style="color:#e6db74">${</span>ARTIFACT_JAVA[*]<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>ARTIFACT_H5[*]<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>
HOST_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/opt/product&#34;</span>

<span style="color:#66d9ef">function</span> usage
<span style="color:#f92672">{</span>
    echo <span style="color:#e6db74">&#34;&#34;</span>
    echo <span style="color:#e6db74">&#34; -h | --host:         部署的目标主机&#34;</span>
    echo <span style="color:#e6db74">&#34; -d | --dir:          部署的目标目录。默认为：</span><span style="color:#e6db74">${</span>HOST_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
    echo <span style="color:#e6db74">&#34; -s | --service-name: 部署的的服务名称，可用的服</span><span style="color:#e6db74">${</span>ARTIFACT_ALL[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">。默认为全部服务&#34;</span>
    echo <span style="color:#e6db74">&#34; -v | --version:      部署的服务的版本。默认为最新的生产构建版本&#34;</span>
    echo <span style="color:#e6db74">&#34; -p | --profile:      部署的环境。&#34;</span>
    echo <span style="color:#e6db74">&#34; --init:              部署后初始化目标机器，将部署的物设置为自动重启的系统服务&#34;</span>
    echo <span style="color:#e6db74">&#34; --start:             部署后启动(重启)服务&#34;</span>
    echo <span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#f92672">}</span>

ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>getopt -o h::d::s::v:p: --lhost::,dir::,service-name::,version:,init,start,profile -n <span style="color:#e6db74">&#39;deploy.sh&#39;</span><span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">`</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? !<span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    usage <span style="color:#f92672">&amp;&amp;</span> exit <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">fi</span>
eval set -- <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ARGS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

ARTIFACT_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/opt/build&#34;</span>
ARTIFACT_VERSION<span style="color:#f92672">=</span>

SPEC_HOST<span style="color:#f92672">=</span>
ARTIFACTS<span style="color:#f92672">=(</span><span style="color:#e6db74">${</span>ARTIFACT_ALL[*]<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>

SPEC_INIT<span style="color:#f92672">=</span>
SPEC_START<span style="color:#f92672">=</span>
<span style="color:#66d9ef">while</span> true
<span style="color:#66d9ef">do</span>
    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> in
        -h|--host<span style="color:#f92672">)</span> 
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> ! -z <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
                SPEC_HOST<span style="color:#f92672">=(</span>$2<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">fi</span>
            shift <span style="color:#ae81ff">2</span>;
            ;;
        -d|--dir<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> ! -z <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
                HOST_DIR<span style="color:#f92672">=</span>$2
            <span style="color:#66d9ef">fi</span>
            shift <span style="color:#ae81ff">2</span>
            ;;
        -s|--service-name<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> ! -z <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
                ARTIFACTS<span style="color:#f92672">=(</span>$2<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">fi</span>
            shift <span style="color:#ae81ff">2</span>
            ;;
        -v|--version<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> ! -z <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
                ARTIFACT_VERSION<span style="color:#f92672">=</span>$2
            <span style="color:#66d9ef">fi</span>
            shift <span style="color:#ae81ff">2</span>
            ;;
        -p|--profile<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> ! -z <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
                PROFILE<span style="color:#f92672">=</span>$2
            <span style="color:#66d9ef">fi</span>
            shift <span style="color:#ae81ff">2</span>
            ;;
        --init<span style="color:#f92672">)</span>
            SPEC_INIT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;true&#34;</span>
            shift
            ;;
        --start<span style="color:#f92672">)</span>
            SPEC_START<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;true&#34;</span>
            shift
            ;;
        --<span style="color:#f92672">)</span>
            shift
            break
            ;;
        *<span style="color:#f92672">)</span>
            usage <span style="color:#f92672">&amp;&amp;</span> exit <span style="color:#ae81ff">1</span>
            ;;
    <span style="color:#66d9ef">esac</span>
<span style="color:#66d9ef">done</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -z <span style="color:#e6db74">&#34;</span>$ARTIFACT_VERSION<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
   <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -f <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ARTIFACT_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/build_number&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
       ARTIFACT_VERSION<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>cat <span style="color:#e6db74">${</span>ARTIFACT_PATH<span style="color:#e6db74">}</span>/build_number<span style="color:#e6db74">`</span>
   <span style="color:#66d9ef">else</span>
       echo -e <span style="color:#e6db74">&#34;\033[32;49;1m 构建文件[</span><span style="color:#e6db74">${</span>ARTIFACT_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/build_num丢失，请修复或通过-v 或 --version 指定部署的版本号&#34;</span> 
       exit <span style="color:#ae81ff">1</span>
   <span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">fi</span>

<span style="color:#75715e"># 1=service, 2=host, 3=host-dir
</span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> transter<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span>
    ssh <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;[[ -d </span>$3<span style="color:#e6db74"> ]] || mkdir </span>$3<span style="color:#e6db74">&#34;</span>

    DST_REPO<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>2<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">${</span>3<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
    SRC_REPO<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ARTIFACT_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>PROFILE<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">${</span>ARTIFACT_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

    SRC_ARTIFACT<span style="color:#f92672">=</span>
    SCP_FLAG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -f <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SRC_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>1<span style="color:#e6db74">}</span><span style="color:#e6db74">.jar&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
        SRC_ARTIFACT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SRC_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>1<span style="color:#e6db74">}</span><span style="color:#e6db74">.jar&#34;</span>
    <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[[</span> -d <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SRC_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>1<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
        SRC_ARTIFACT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SRC_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>1<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
        SCP_FLAG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-r &#34;</span>
    <span style="color:#66d9ef">else</span>
        echo -e <span style="color:#e6db74">&#34;\033[32;49;1m 资源[</span><span style="color:#e6db74">${</span>SRC_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>1<span style="color:#e6db74">}</span><span style="color:#e6db74">]不存在\033[39;49;0m&#34;</span>
        exit <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>    

    echo <span style="color:#e6db74">&#34;copying </span><span style="color:#e6db74">${</span>SRC_ARTIFACT<span style="color:#e6db74">}</span><span style="color:#e6db74"> to </span><span style="color:#e6db74">${</span>DST_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/&#34;</span> 
    scp <span style="color:#e6db74">${</span>SCP_FLAG<span style="color:#e6db74">}${</span>SRC_ARTIFACT<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>DST_REPO<span style="color:#e6db74">}</span>/ &gt; /dev/null
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -z <span style="color:#e6db74">&#34;</span>$SCP_FLAG<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
            ssh <span style="color:#e6db74">&#34;</span>$HOST<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;chmod u+x </span><span style="color:#e6db74">${</span>3<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>1<span style="color:#e6db74">}</span><span style="color:#e6db74">.jar&#34;</span>
        <span style="color:#66d9ef">fi</span>              
        echo -n <span style="color:#e6db74">`</span>date <span style="color:#e6db74">&#34;+%Y-%m-%d %H:%M:%S&#34;</span><span style="color:#e6db74">`</span> &gt;&gt; <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SRC_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/info&#34;</span>
        echo <span style="color:#e6db74">&#34;   同步[SRC_ARTIFACT]到</span><span style="color:#e6db74">${</span>DST_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/&#34;</span> &gt;&gt; <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SRC_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/info&#34;</span>

        echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ARTIFACT_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> &gt; <span style="color:#e6db74">&#34;TMP_</span><span style="color:#e6db74">${</span>ARTIFACT_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
        scp <span style="color:#e6db74">&#34;TMP_</span><span style="color:#e6db74">${</span>ARTIFACT_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DST_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">/version&#34;</span> &gt; /dev/null
        rm -f <span style="color:#e6db74">&#34;TMP_</span><span style="color:#e6db74">${</span>ARTIFACT_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#66d9ef">else</span>
        echo -e <span style="color:#e6db74">&#34;\033[31;1m 拷贝资源[SRC_ARTIFACT]失败\033[0m&#34;</span>
        exit <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">function</span> init<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ARTIFACT_JAVA[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span>~ <span style="color:#e6db74">&#34;</span>$3<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
        ssh $1 <span style="color:#e6db74">&#34;ln -sif </span><span style="color:#e6db74">${</span>2<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>3<span style="color:#e6db74">}</span><span style="color:#e6db74">.jar /etc/init.d/</span><span style="color:#e6db74">${</span>3<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
        TMP_CONF_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;TMP_CONF_</span><span style="color:#e6db74">${</span>ARTIFACT_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
        echo <span style="color:#e6db74">&#34;JAVA_OPTS=\&#34;-Djava.security.egd=file:/dev/./urandom -ser-Xms1024m -Xmx2048m\&#34;&#34;</span> &gt; <span style="color:#e6db74">&#34;</span>$TMP_CONF_FILE<span style="color:#e6db74">&#34;</span>
        echo <span style="color:#e6db74">&#34;LOG_FOLDER=\&#34;/var/log/paltformname/</span><span style="color:#e6db74">${</span>ARTIFACT_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;&#34;&#34;</span>$TMP_CONF_FILE<span style="color:#e6db74">&#34;</span>
        echo <span style="color:#e6db74">&#34;RUN_ARGS=\&#34;--spring.profiles.active=</span><span style="color:#e6db74">${</span>PROFI--application.build-number=<span style="color:#e6db74">${</span>ARTIFACT_VERSION<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;&#34;</span>$TMP_CONF_FILE<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">        echo -n &#34;</span># 自动配置于<span style="color:#e6db74">&#34; &gt;&gt; &#34;</span>$TMP_CONF_FILE<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">        echo `date &#34;</span>+%Y-%m-%d %H:%M:%S<span style="color:#e6db74">&#34;` &gt;&gt; &#34;</span>$TMP_CONF_FILE<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">        
</span><span style="color:#e6db74">        CONF_DIR=&#34;</span>/etc/hd<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">        ssh &#34;</span>$1<span style="color:#e6db74">&#34; &#34;</span>[[ -d <span style="color:#e6db74">${</span>CONF_DIR<span style="color:#e6db74">}</span> ]] || mkdir <span style="color:#e6db74">${</span>CONF_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">        scp &#34;</span>$TMP_CONF_FILE<span style="color:#e6db74">&#34; &#34;</span>$1:<span style="color:#e6db74">${</span>CONF_DIR<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>3<span style="color:#e6db74">}</span>.conf<span style="color:#e6db74">&#34; &gt; /dev/null
</span><span style="color:#e6db74">        
</span><span style="color:#e6db74">        rm -rf </span>$TMP_CONF_FILE<span style="color:#e6db74">
</span><span style="color:#e6db74">        ssh </span>$1<span style="color:#e6db74"> &#34;</span>chkconfig --add <span style="color:#e6db74">${</span>3<span style="color:#e6db74">}</span> &amp;&amp; chkconfig <span style="color:#e6db74">${</span>3<span style="color:#e6db74">}</span> on<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">        
</span><span style="color:#e6db74">        if [[ </span>$?<span style="color:#e6db74"> == 0 ]]; then
</span><span style="color:#e6db74">            echo -e &#34;</span><span style="color:#ae81ff">\0</span>33[32m 初始化主机[<span style="color:#e6db74">${</span>1<span style="color:#e6db74">}</span>]服务[<span style="color:#e6db74">${</span>3<span style="color:#e6db74">}</span>]成功 <span style="color:#ae81ff">\0</span>33[0m<span style="color:#e6db74">&#34; 
</span><span style="color:#e6db74">        else
</span><span style="color:#e6db74">            echo -e &#34;</span><span style="color:#ae81ff">\0</span>33[31m 初始化主机[<span style="color:#e6db74">${</span>1<span style="color:#e6db74">}</span>]服务[<span style="color:#e6db74">${</span>3<span style="color:#e6db74">}</span>]失败 <span style="color:#ae81ff">\0</span>33[0m<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">        fi
</span><span style="color:#e6db74">        return 0
</span><span style="color:#e6db74">    else
</span><span style="color:#e6db74">       echo &#34;</span><span style="color:#e6db74">${</span>3<span style="color:#e6db74">}</span>不是JAVA构件，不能进行服务化初始化<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">       return 1
</span><span style="color:#e6db74">    fi
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">for ARTIFACT in </span><span style="color:#e6db74">${</span>ARTIFACTS[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span><span style="color:#e6db74">do
</span><span style="color:#e6db74">    if [[ ! &#34;</span><span style="color:#e6db74">${</span>ARTIFACT_ALL[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; =~ &#34;</span><span style="color:#e6db74">${</span>ARTIFACT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">        echo -e &#34;</span><span style="color:#ae81ff">\0</span>33[31;1m 不支持服务[<span style="color:#e6db74">${</span>ARTIFACT<span style="color:#e6db74">}</span>]的部署<span style="color:#ae81ff">\0</span>33[0m<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">        continue
</span><span style="color:#e6db74">    fi
</span><span style="color:#e6db74">  
</span><span style="color:#e6db74">    ARTIFACT_DST_HOST=
</span><span style="color:#e6db74">    if [[ ! -z &#34;</span>$SPEC_HOST<span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">        ARTIFACT_DST_HOST=(</span><span style="color:#e6db74">${</span>SPEC_HOST[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">)
</span><span style="color:#e6db74">    elif [[ &#34;</span><span style="color:#e6db74">${</span>ARTIFACT_SERVICE[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; =~ &#34;</span>$ARTIFACT<span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">        sleep 2     #  让服务有足够的时间启动
</span><span style="color:#e6db74">        ARTIFACT_DST_HOST=</span><span style="color:#e6db74">${</span>SERVER_SERVICE[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    elif [[ &#34;</span><span style="color:#e6db74">${</span>ARTIFACT_WEB[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; =~ &#34;</span>$ARTIFACT<span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">        ARTIFACT_DST_HOST=</span><span style="color:#e6db74">${</span>SERVER_WEB[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    elif [[ &#34;</span><span style="color:#e6db74">${</span>ARTIFACT_H5[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; =~ &#34;</span>$ARTIFACT<span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">        ARTIFACT_DST_HOST=</span><span style="color:#e6db74">${</span>SERVER_H5[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    else
</span><span style="color:#e6db74">        echo -e &#34;</span><span style="color:#ae81ff">\0</span>33[31;1m 脚本出错了，请报告运维人员修复<span style="color:#ae81ff">\0</span>33[0m<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">        continue
</span><span style="color:#e6db74">    fi
</span><span style="color:#e6db74">    
</span><span style="color:#e6db74">    echo -e &#34;</span><span style="color:#ae81ff">\0</span>33[32m <span style="color:#ae81ff">\n</span>正在同步服务[<span style="color:#e6db74">${</span>ARTIFACT<span style="color:#e6db74">}</span>]...... <span style="color:#ae81ff">\0</span>33[0m<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    for HOST in </span><span style="color:#e6db74">${</span>ARTIFACT_DST_HOST[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    do
</span><span style="color:#e6db74">        transter </span>$ARTIFACT<span style="color:#e6db74"> </span>$HOST<span style="color:#e6db74"> </span>$HOST_DIR<span style="color:#e6db74">
</span><span style="color:#e6db74">        if [[ </span>$?<span style="color:#e6db74"> == 0 ]]; then
</span><span style="color:#e6db74">            if [[ ! -z &#34;</span>$SPEC_INIT<span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">                init </span>$HOST<span style="color:#e6db74"> </span>$HOST_DIR<span style="color:#e6db74"> </span>$ARTIFACT<span style="color:#e6db74"> &amp;&amp; [[ ! -z &#34;</span>$SPEC_START<span style="color:#e6db74">&#34;&amp;&amp; ssh </span>$HOST<span style="color:#e6db74"> &#34;</span>service <span style="color:#e6db74">${</span>ARTIFACT<span style="color:#e6db74">}</span> start<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">            elif [[ &#34;</span><span style="color:#e6db74">${</span>ARTIFACT_JAVA[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; =~ &#34;</span>$ARTIFACT<span style="color:#e6db74">&#34; ]]; then
</span><span style="color:#e6db74">               CONF_FILE=&#34;</span>/etc/hd/<span style="color:#e6db74">${</span>ARTIFACT<span style="color:#e6db74">}</span>.conf<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">               ssh </span>$HOST<span style="color:#e6db74"> &#34;</span>[[ ! -f $CONF_FILE ]]<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">               if [[ </span>$?<span style="color:#e6db74"> == 0 ]]; then
</span><span style="color:#e6db74">                   echo &#34;</span>主机[<span style="color:#e6db74">${</span>HOST<span style="color:#e6db74">}</span>]尚未配置服务[<span style="color:#e6db74">${</span>ARTIFACT<span style="color:#e6db74">}</span>]，建deploy.sh -h<span style="color:#e6db74">${</span>HOST<span style="color:#e6db74">}</span> -d<span style="color:#e6db74">${</span>HOST_DIR<span style="color:#e6db74">}</span> --i-s<span style="color:#e6db74">${</span>ARTIFACT<span style="color:#e6db74">}</span>进行初始化<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">               else
</span><span style="color:#e6db74">                   ssh </span>$HOST<span style="color:#e6db74"> &#34;</span>sed -i <span style="color:#e6db74">&#39;s/\(--application.build-number=\)igit:]]*/\1${ARTIFACT_VERSION}/g&#39;</span> $CONF_FILE<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">                   ssh </span>$HOST<span style="color:#e6db74"> &#34;</span>sed -i <span style="color:#e6db74">&#39;s/^LOG_FOLDER=.*/LOG_FOLDER=\&#34;\/vlog\/paltformname\/${ARTIFACT_VERSION}\&#34;/g&#39;</span> $CONF_FILE<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">                   ssh </span>$HOST<span style="color:#e6db74"> &#34;</span>[[ -d /var/log/paltformname ]] || mkdir /log/paltformname<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">                   ssh </span>$HOST<span style="color:#e6db74"> &#34;</span>[[ -d /var/paltformname/<span style="color:#e6db74">${</span>ARTIFACT_VERSION<span style="color:#e6db74">}</span> ]] || mkdir /var/paltformname/<span style="color:#e6db74">${</span>ARTIFACT_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">                   [[ ! -z &#34;</span>$SPEC_START<span style="color:#e6db74">&#34; ]] &amp;&amp; ssh </span>$HOST<span style="color:#e6db74"> &#34;</span>serv<span style="color:#e6db74">${</span>ARTIFACT<span style="color:#e6db74">}</span> restart<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">               fi
</span><span style="color:#e6db74">            fi
</span><span style="color:#e6db74">        fi
</span><span style="color:#e6db74">    done
</span><span style="color:#e6db74">done</span></code></pre></div></p></article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="http://www.szlx.me/tags/java"><span class="tag">Java</span></a></li>
        
          <li><a href="http://www.szlx.me/tags/%E9%83%A8%E7%BD%B2"><span class="tag">部署</span></a></li>
        
          <li><a href="http://www.szlx.me/tags/%E8%84%9A%E6%9C%AC"><span class="tag">脚本</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you likes to quote or reproduce.This post was published <strong>220</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.
      </p>
    </footer>
    
      <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "disqus_shortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
    
  </section>
  <footer class="site-footer">
  <p>© 2017-2018 在路上</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

<script src="http://www.szlx.me/js/bundle.d1288006cf.js"></script>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





  </body>
</html>
